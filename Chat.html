<!-- uploaded_file_url: /mnt/data/E7AF0879-556D-4B9D-B921-919DDD440BD0.jpeg -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simple Gist Chat (plain text)</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; margin:0; background:#f7f7f8; color:#111; }
  .wrap { max-width:720px; margin:20px auto; padding:16px; background:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
  header { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
  header h1 { font-size:18px; margin:0; }
  #chatBox { white-space:pre-wrap; background:#111827; color:#fff; padding:12px; border-radius:8px; min-height:220px; overflow:auto; font-family: Menlo, monospace; }
  .controls { display:flex; gap:8px; margin-top:12px; }
  input[type=text], textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:15px; box-sizing:border-box; }
  textarea { min-height:80px; resize:vertical; }
  button { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:600; background:#1d4ed8; color:white; }
  button.ghost { background:#e5e7eb; color:#111; }
  .top-row { display:flex; gap:8px; margin-bottom:10px; align-items:center; justify-content:space-between;}
  .small { font-size:12px; color:#666; }
  #tokenStatus { font-size:13px; color:#444; margin-left:8px; }
  .danger { background:#dc2626; color:white; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top-row">
      <div>
        <header>
          <h1>Gist Chat (plain text)</h1>
          <div id="tokenStatus" class="small"></div>
        </header>
        <div class="small">Gist ID: <strong id="gistIdLabel">bacb0944d51800b24bc9b3e54bfb4216</strong> &middot; File: <strong id="fileNameLabel">gistfile1.txt</strong></div>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="btnToken" class="ghost">Set Token</button>
        <button id="btnRefresh" class="ghost">Refresh</button>
      </div>
    </div>

    <div id="chatBox" aria-live="polite">Loading chat…</div>

    <div style="margin-top:12px">
      <textarea id="messageInput" placeholder="Type your message here…"></textarea>
      <div class="controls">
        <button id="btnSend">Send</button>
        <button id="btnClear" class="danger">Delete chat</button>
        <button id="btnName" class="ghost">Set name</button>
        <button id="btnToggleAuto" class="ghost">Auto-refresh: on</button>
      </div>
      <div class="small" style="margin-top:8px">
        <span id="statusText">Ready.</span>
      </div>
    </div>
  </div>

<script>
(() => {
  // CONFIG (user-provided)
  const GIST_ID = "bacb0944d51800b24bc9b3e54bfb4216";
  const FILE_NAME = "gistfile1.txt";

  // UI elements
  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("messageInput");
  const btnSend = document.getElementById("btnSend");
  const btnClear = document.getElementById("btnClear");
  const btnRefresh = document.getElementById("btnRefresh");
  const btnToken = document.getElementById("btnToken");
  const btnName = document.getElementById("btnName");
  const statusText = document.getElementById("statusText");
  const tokenStatus = document.getElementById("tokenStatus");
  const btnToggleAuto = document.getElementById("btnToggleAuto");

  document.getElementById("gistIdLabel").innerText = GIST_ID;
  document.getElementById("fileNameLabel").innerText = FILE_NAME;

  // State
  let autoRefresh = true;
  let refreshInterval = 6000; // ms
  let timer = null;
  let lastFetched = ""; // track to detect changes
  let username = sessionStorage.getItem("gistChatName") || "You";

  function setTokenUI() {
    const tk = sessionStorage.getItem("gistChatToken");
    tokenStatus.textContent = tk ? "Token set (session)" : "No token set";
  }

  function setNameUI() {
    btnName.textContent = username === "You" ? "Set name" : username;
  }

  setTokenUI();
  setNameUI();

  // Helpers: show status
  function setStatus(s) { statusText.innerText = s; }

  // Fetch Gist via API (returns the file content text)
  async function fetchGistContent() {
    setStatus("Fetching chat…");
    const apiUrl = `https://api.github.com/gists/${GIST_ID}?t=${Date.now()}`;
    try {
      const r = await fetch(apiUrl);
      if (!r.ok) throw new Error("Fetch failed: " + r.status);
      const data = await r.json();
      if (!data.files || !data.files[FILE_NAME]) {
        chatBox.textContent = "(file not found in gist)";
        setStatus("File missing.");
        return "";
      }
      // API returns content in data.files[FILE_NAME].content
      const content = data.files[FILE_NAME].content || "";
      chatBox.textContent = content || "(empty)";
      // scroll to bottom
      chatBox.scrollTop = chatBox.scrollHeight;
      setStatus("Chat updated " + new Date().toLocaleTimeString());
      return content;
    } catch (err) {
      chatBox.textContent = "(error loading chat)";
      setStatus("Error: " + err.message);
      return "";
    }
  }

  // Update (overwrite) gist file content with the provided text
  async function updateGistContent(newText) {
    const token = sessionStorage.getItem("gistChatToken");
    if (!token) {
      alert("You must set a GitHub token with gist scope first (Set Token).");
      return false;
    }
    setStatus("Sending message…");
    const url = `https://api.github.com/gists/${GIST_ID}`;
    const body = {
      files: {}
    };
    body.files[FILE_NAME] = { content: newText };

    try {
      const r = await fetch(url, {
        method: "PATCH",
        headers: {
          "Accept": "application/vnd.github+json",
          "Authorization": "token " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error("HTTP " + r.status + " - " + txt);
      }
      const json = await r.json();
      setStatus("Sent ✓");
      return true;
    } catch (err) {
      setStatus("Send failed: " + err.message);
      alert("Failed to update gist: " + err.message);
      return false;
    }
  }

  // Append a message (we read current content, append one line, write back)
  async function appendMessage(text) {
    // Read current content
    const current = await fetchGistContent();
    // Prepare line: [Name] (HH:MM) — message
    const ts = new Date();
    const hhmm = ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const line = `${username} [${hhmm}]: ${text}`;
    const newContent = (current && current !== "(empty)") ? (current + "\n" + line) : line;
    const ok = await updateGistContent(newContent);
    if (ok) {
      // Show updated content
      await fetchGistContent();
    }
  }

  // Clear chat
  async function clearChat() {
    if (!confirm("Are you sure you want to DELETE the whole chat history?")) return;
    const ok = await updateGistContent("");
    if (ok) {
      chatBox.textContent = "(empty)";
      setStatus("Chat cleared");
    }
  }

  // UI events
  btnSend.addEventListener("click", async () => {
    const txt = messageInput.value.trim();
    if (!txt) return;
    btnSend.disabled = true;
    await appendMessage(txt);
    messageInput.value = "";
    btnSend.disabled = false;
  });

  btnClear.addEventListener("click", async () => {
    await clearChat();
  });

  btnRefresh.addEventListener("click", async () => {
    await fetchGistContent();
  });

  btnToken.addEventListener("click", async () => {
    const current = sessionStorage.getItem("gistChatToken") || "";
    const t = prompt("Paste your GitHub Personal Access Token (gist scope). This will be stored only in this browser session.", current);
    if (t !== null) {
      if (t.trim() === "") {
        sessionStorage.removeItem("gistChatToken");
      } else {
        sessionStorage.setItem("gistChatToken", t.trim());
      }
      setTokenUI();
    }
  });

  btnName.addEventListener("click", () => {
    const n = prompt("Set display name (short):", username);
    if (n !== null && n.trim() !== "") {
      username = n.trim();
      sessionStorage.setItem("gistChatName", username);
      setNameUI();
    }
  });

  btnToggleAuto.addEventListener("click", () => {
    autoRefresh = !autoRefresh;
    btnToggleAuto.textContent = "Auto-refresh: " + (autoRefresh ? "on" : "off");
    if (autoRefresh) startAuto();
    else stopAuto();
  });

  function startAuto() {
    if (timer) clearInterval(timer);
    timer = setInterval(async () => {
      const content = await fetchGistContent();
      if (content !== lastFetched) {
        lastFetched = content;
      }
    }, refreshInterval);
  }
  function stopAuto() { if (timer) clearInterval(timer); timer = null; }

  // Initial load
  (async function init() {
    lastFetched = await fetchGistContent();
    // focus input on mobile
    messageInput.focus();
    if (autoRefresh) startAuto();
    setStatus("Ready");
  })();

  // keyboard: send on CMD/CTRL+Enter
  messageInput.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      btnSend.click();
    }
  });

  // expose for debugging
  window.gistChat = {
    fetchGistContent, updateGistContent, appendMessage, clearChat
  };
})();
</script>
</body>
</html>

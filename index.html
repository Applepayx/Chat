<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gist Chat - Dark WhatsApp</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; margin:0; background:#121b22; color:#e1e1e1; }
  .wrap { max-width:720px; margin:0 auto; display:flex; flex-direction:column; height:100vh; }
  header { background:#075e54; color:white; padding:14px 16px; font-size:18px; font-weight:600; }
  .small { font-size:12px; color:#b0b0b0; }
  #chatBox { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:6px; }
  .bubble { padding:10px 14px; border-radius:16px; max-width:70%; word-break:break-word; position:relative; line-height:1.4; }
  .bubble.you { background:#056162; color:white; align-self:flex-end; border-bottom-right-radius:2px; }
  .bubble.other { background:#1e2a32; color:#e1e1e1; align-self:flex-start; border-bottom-left-radius:2px; }
  .timestamp { font-size:10px; opacity:0.6; margin-top:2px; text-align:right; }
  #inputWrap { display:flex; gap:6px; padding:10px; background:#1a242f; }
  textarea { flex:1; border-radius:20px; padding:10px 14px; border:none; background:#2c3e50; color:white; resize:none; }
  button { border:none; border-radius:20px; background:#25d366; color:white; font-weight:600; padding:10px 16px; cursor:pointer; }
  .controls { display:flex; gap:8px; margin-top:12px; }
  button.ghost { background:#2c3e50; color:white; }
  button.danger { background:#dc2626; color:white; }
</style>
</head>
<body>
  <div class="wrap">
    <header>Gist Chat (Dark WhatsApp)</header>
    <div id="chatBox" aria-live="polite">Loading chat…</div>
    <div id="inputWrap">
      <textarea id="messageInput" placeholder="Type your message…"></textarea>
      <button id="btnSend">Send</button>
    </div>
    <div class="controls" style="background:#121b22; padding:10px;">
      <button id="btnToken" class="ghost">Set Token</button>
      <button id="btnClear" class="danger">Delete chat</button>
      <button id="btnRefresh" class="ghost">Refresh</button>
      <button id="btnName" class="ghost">Set name</button>
    </div>
    <div class="small" style="padding:4px 12px; color:#b0b0b0;">
      <span id="statusText">Ready.</span>
    </div>
  </div>

<script>
(() => {
  const GIST_ID = "bacb0944d51800b24bc9b3e54bfb4216";
  const FILE_NAME = "gistfile1.txt";

  const chatBox = document.getElementById("chatBox");
  const messageInput = document.getElementById("messageInput");
  const btnSend = document.getElementById("btnSend");
  const btnClear = document.getElementById("btnClear");
  const btnRefresh = document.getElementById("btnRefresh");
  const btnToken = document.getElementById("btnToken");
  const btnName = document.getElementById("btnName");
  const statusText = document.getElementById("statusText");

  let username = sessionStorage.getItem("gistChatName") || "You";
  let autoRefresh = true;
  let refreshInterval = 6000;
  let timer = null;
  let lastFetched = "";

  function setStatus(s){ statusText.textContent=s; }

  function appendBubble(msg, from="you"){
    const div = document.createElement("div");
    div.className = "bubble " + (from==="you"?"you":"other");
    div.textContent = msg;
    const ts = document.createElement("div");
    ts.className = "timestamp";
    ts.textContent = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    div.appendChild(ts);
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function fetchGistContent() {
    setStatus("Fetching chat…");
    try {
      const r = await fetch(`https://api.github.com/gists/${GIST_ID}?t=${Date.now()}`);
      if(!r.ok) throw new Error(r.status);
      const data = await r.json();
      const content = data.files[FILE_NAME]?.content || "";
      chatBox.innerHTML = "";
      content.split("\n").forEach(line=>{
        if(!line.trim()) return;
        const from = line.startsWith(username)?"you":"other";
        appendBubble(line, from);
      });
      setStatus("Chat updated "+new Date().toLocaleTimeString());
      return content;
    } catch(e) {
      chatBox.textContent="(error loading chat)";
      setStatus("Error: "+e.message);
      return "";
    }
  }

  async function updateGistContent(newText){
    const token = sessionStorage.getItem("gistChatToken");
    if(!token){ alert("Set your GitHub token first"); return false; }
    setStatus("Sending message…");
    try{
      const r = await fetch(`https://api.github.com/gists/${GIST_ID}`,{
        method:"PATCH",
        headers:{
          "Accept":"application/vnd.github+json",
          "Authorization":"token "+token,
          "Content-Type":"application/json"
        },
        body:JSON.stringify({ files:{ [FILE_NAME]:{ content:newText } } })
      });
      if(!r.ok) throw new Error("HTTP "+r.status);
      setStatus("Sent ✓");
      return true;
    }catch(e){
      setStatus("Send failed: "+e.message);
      alert("Failed to update gist: "+e.message);
      return false;
    }
  }

  async function appendMessage(text){
    const current = await fetchGistContent();
    const ts = new Date();
    const hhmm = ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const line = `${username} [${hhmm}]: ${text}`;
    const newContent = current?(current+"\n"+line):line;
    if(await updateGistContent(newContent)){
      await fetchGistContent();
    }
  }

  async function clearChat(){
    if(!confirm("Delete all chat history?")) return;
    if(await updateGistContent("")) setStatus("Chat cleared");
    chatBox.innerHTML="(empty)";
  }

  btnSend.addEventListener("click", async ()=>{
    const txt = messageInput.value.trim();
    if(!txt) return;
    btnSend.disabled=true;
    await appendMessage(txt);
    messageInput.value="";
    btnSend.disabled=false;
  });

  btnClear.addEventListener("click", clearChat);
  btnRefresh.addEventListener("click", fetchGistContent);

  btnToken.addEventListener("click", ()=>{
    const t = prompt("Paste your GitHub token (session only):", sessionStorage.getItem("gistChatToken")||"");
    if(t!==null){ t.trim()===""?sessionStorage.removeItem("gistChatToken"):sessionStorage.setItem("gistChatToken",t.trim()); }
  });

  btnName.addEventListener("click", ()=>{
    const n = prompt("Set display name:", username);
    if(n && n.trim()!==""){ username=n.trim(); sessionStorage.setItem("gistChatName",username); }
  });

  messageInput.addEventListener("keydown", e=>{
    if((e.ctrlKey||e.metaKey)&&e.key==="Enter") btnSend.click();
  });

  (async function init(){
    await fetchGistContent();
    messageInput.focus();
    if(autoRefresh) timer=setInterval(fetchGistContent, refreshInterval);
  })();

})();
</script>
</body>
</html>
